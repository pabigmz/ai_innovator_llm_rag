import os
import streamlit as st
from groq import Groq
from qdrant_client import QdrantClient
from qdrant_client.models import PointStruct, VectorParams, Distance
from sentence_transformers import SentenceTransformer
from dotenv import load_dotenv

# 1. โหลด environment variables จากไฟล์ .env
load_dotenv()

# 2. เริ่มต้น Qdrant (แบบ In-Memory)
# ใช้ In-Memory
qdrant_client = QdrantClient(":memory:")

# สร้าง Collection สำหรับเก็บเวกเตอร์
qdrant_client.recreate_collection(
    collection_name="documents",
    vectors_config=VectorParams(
        size=384, distance=Distance.COSINE
    ),  # ใช้ 384-D embedding
)

# 3. ข้อมูลเอกสารที่กำหนดเอง

documents = [
    "อุทยานแห่งชาติดอยภูคา ที่เที่ยวน่าน อุทยานแห่งชาติดอยภูคา จ.น่าน อุทยานที่เต็มไปด้วยความอุดมสมบูรณ์ทางธรรมชาติและมีอากาศที่บริสุทธิ์ตลอดทั้งปี และที่เป็นไฮไลท์ของดอยภูคาเลยก็คือ ดอกชมพูภูคา ที่จะบานช่วงเดือนกุมภาพันธ์ และยังต้นไม้หายากที่มีที่นี่ที่เดียวในเมืองไทย นอกจากนี้ทางอุทยานฯ ยังมีบ้านพักและพื้นที่สำหรับกางเต็นท์ไว้รองรับนักท่องเที่ยว หน้าหนาวที่จะถึงนี้ ลองหนีมาเที่ยว มาสูดโอโซนให้เต็มปอดและมานอนที่ดอยภูคากันสักคืน รับรองความฟินที่ต้องมาสัมผัสให้ได้สักครั้ง",
    "1715 อุทยานแห่งชาติดอยภูคา ที่เที่ยวน่าน จุดชมวิว 1715 เป็นจุดชมวิวระหว่างทางลงไปเมืองปัวเพื่อกลับเข้าเมืองเป็นละทางกับที่เราขึ้นเขาทางโค้งไม่เยอะมากเหมือนตอนขาขึ้นและระยะทางลงเขายังสั้นกว่ามากคนในพื้นที่แนะนำให้ใช้เส้นทางนี้ จุดชมวิว 1715 สวยงามมากขนาดเรามาถึงใกล้จะมึดแล้วเขาสูงสลับกันไปมาเริ่มมีหมอกบางๆ นิดๆ อากาศเริ่มเย็นจัด",
    "ดอยภูแว : ดอยภูแว ที่เที่ยวน่านธรรมชาติเป็นยอดเขาสูง 1837 เมตรจากระดับน้ำทะเล ในพื้นที่ของอุทยานแห่งชาติดอยภูคา จังหวัดน่านโดยทางเดินช่วงแรกเดินขึ้นจากหน่วย ฯ ระยะทางสั้น ๆ แต่ชันพอสมควร ไปเจอถนนลูกรังไปยังหมู่บ้านปูดู่ 2 กม. เดินผ่านไปท้ายหมู่บ้านเลี้ยวซ้ายขึ้นไปผ่านไร่ข้าวโพด เดินสบาย ๆ ชมวิวเขาทั้งลูกมีแต่ต้นข้าวโพดอีก 2 กม. ผ่านรั้วเข้าเขตป่า จุดนี้ชันสุดๆ ตามต้นไม้มีจะรอยบากบอกทางเป็นระยะ ๆ อีก 2 กม. ถึงลานโล่ง ๆ เป็นจุดกางเต็นท์ มองขึ้นไปเห็นยอดดอย ส่วนตัวใช้เวลา 3 ชั่วโมงทั่วไปใช้เวลาเฉลี่ย 4-5 ชม. ด้านบนไม่มีสิ่งอำนวยความสะดวกใดๆ ไม่มีห้องน้ำ ไม่มีสัญญาณ",
    "อาหารเช้า&เฉาก๊วยนมสด :วัดพระธาตุเขาน้อย ที่เที่ยวน่านในเมืองโดยตั้งอยู่บนยอด ดอยเขาน้อย ทางด้านตะวันตกของน่าน องค์พระธาตุตั้งอยู่บนยอดดอยเขาน้อย สูงจากระดับน้ำทะเลประมาณ 240 เมตรเลยทีเดียว เป็นเจดีย์ก่ออิฐถือปูนทั้งองค์ งดงามแบบศิลปะพม่าผสมล้านนา นอกจากเราจะได้มาสักการะบูชาพระธาตุคู่บ้านคู่เมืองน่านกันแล้ว ตรงจุดลานปูนนั้น ประดิษฐานพระพุทธรูปองค์ใหญ่ คือ พระพุทธมหาอุตมมงคลนันทบุรีศรีเมืองน่าน และในบริเวณที่ประดิษฐาน พระพุทธมหาอุตมมงคลนันทบุรีศรีเมืองน่าน อีกทั้งยังเป็นจุดชมวิวทะเลหมอก ในยามเช้า ที่เราจะสามารถมองเห็นหมอกปกคลุมไปทั่วบริเวณสวยงามจริงๆ รวมไปถึงการเห็นวิวของเมืองน่านได้ทั้งเมือง โดยมีภูเขาเป็นฉากหลังที่โอบล้อมเมืองอยู่อย่างสวยงามอลังการมากทีเดียว",
    "บ่อเกลือสินเธาว์ : ที่เที่ยวน่าน บ่อเกลือสินเธาว์ นั้นเรียกได้ว่านอกจากบรรยากาศของสถานที่จะดีแล้ว เหล่าพ่อค้าแม่ค้าน่ารัก พูดจาดีกันทั้งนั้น สามารถเข้าไปถ่ายรูปได้ ที่จอดรถไม่ค่อยมี ต้องจอดตามข้างทางแล้วค่อยเดินมา ของฝากจากที่นี่ก็คงจะเป็นเกลือ เพราะมาบ่อเกลือ มีทั้งเกลือแช่เท้า เกลือสมุนไพร เกลือทำกับข้าว ฯลฯ มีให้เลือกมากมายหลายราคาตามกำลังที่จะซื้อกันเลย",
    "โรงเรียนชาวนาตำบลศิลาเพชร (Farmer School): ที่เที่ยวน่าน ฟาร์มสเตย์โรงเรียนชาวนา ที่พักใจกลางทุ่งนา ในราคาหลักร้อย แต่บรรยากาศหลักล้าน ที่พักอยู่ในอำเภอปัว จ.น่าน มีทั้งแนวห้องแอร์ และพัดลม แต่ใครที่มาพักช่วงหน้าหนาวบอกเลยว่าอากาศเย็นมาก นอกจากนั้นยังมีมุมถ่ายรูปสวยๆ หลายมุมเลย ทำให้การถ่ายรูปลงโซเชียลหรือเก็บภาพไว้ในความทรงจำ จะมีแต่ความสวยงามจนลืมไม่ลง และอยากจะกลับมาซ้ำอีกแน่นอน",
    "วัดปรางค์ : ที่เที่ยวน่าน วัดปรางค์ พลาดไม่ได้ หากมาอำเภอปัว ต้องได้ชม และสัมผัส กับ ต้นดิกเดียม ต้นไม้ที่เป็น Unseen Thailand ที่อยู่คู่วัดปรางค์แห่งอำเภอปัวมานานนับร้อยปี มากราบสักการะ พระปรางค์มุณีศรีไตรเขต และ พระธาตุบุญนาค ที่เป็นที่เคารพบูชาของผู้คนในตำบลปัว เป็นอีกหนึ่งที่เที่ยวน่านในเมืองที่สามารถได้ทั้งบุญ และบรรยากาศดี ๆ จนเกิดความสุขไม่ว่าจะทางกายหรือทางใจ",
    "วัดภูมินทร์ :ที่เที่ยวน่าน วัดภูมินทร์ เป็นวัดอารามหลวงใจกลางเมืองน่าน เป็นวัดที่มีภาพวาดในสมัยโบราณที่สวยงามตามรูปแบบของชาวล้านนา มีภาพของปู่ม่านย่าม่านกับภาพวาดกระซิบรัก ณ น่าน อันมีชื่อเสียงที่ไม่ว่าใครก็ต้องมารับชมด้วยตาของตัวเอง และยังมีพระพุทธรูปองค์ใหญ่ 4 ด้านให้เราได้กราบสักการะ โบสถ์เก่าแก่และสวยงาม เพื่อให้ได้ขอพร สำหรับความเจริญ",
]


# แปลงข้อความเป็นเวกเตอร์ และเพิ่มลงใน Qdrant
def add_documents_to_qdrant(documents):
    embedding_model = SentenceTransformer(
        "all-MiniLM-L6-v2"
    )  # โหลดโมเดลสำหรับทำ Embedding
    vectors = embedding_model.encode(documents).tolist()  # แปลงข้อความเป็นเวกเตอร์

    # เพิ่มข้อมูลลง Qdrant
    points = [
        PointStruct(id=i, vector=vectors[i], payload={"text": documents[i]})
        for i in range(len(documents))
    ]
    qdrant_client.upsert(collection_name="documents", points=points)


# 5. สร้างฟังก์ชันการค้นหาเอกสาร
def search_documents(query):
    embedding_model = SentenceTransformer("all-MiniLM-L6-v2")
    query_vector = embedding_model.encode([query])[0].tolist()
    search_results = qdrant_client.search(
        collection_name="documents",
        query_vector=query_vector,
        # ดึงเอกสารที่เกี่ยวข้อง 5 อันดับแรก
        limit=5,
    )
    return [hit.payload["text"] for hit in search_results]


# 6. สร้างฟังก์ชันการสร้างคำตอบด้วย Groq
def generate_answer(query):

    system_prompt = """
    คุณคือ AI chatbot ผู้ช่วยแนะนำสถาน ที่ท่องเที่ยว
    ให้ตอบ เฉพาะข้อมูลที่อยู่ ในเอกสารเท่านั้น
    หากผู้ใช้สอบถามสถานที่ที่ไม่อยู่ในจังหวัดน่าน ให้ตอบว่า
    'ขออภัย สถานนั้นไม่มีข้อมูลอยู่
    """

    temperature = 0.7

    retrieved_docs = search_documents(query)
    context = "\n".join(retrieved_docs)
    full_prompt = (
        f"{system_prompt}\n\nข้อมูลอ้างอิง:\n{context}\n\nคำถาม: {query}\n\nคำตอบ:"
    )

    # debug
    # print(full_prompt)

    groq_client = Groq(api_key=os.getenv("GROQ_API_KEY"))
    response = groq_client.chat.completions.create(
        # model LLM
        model="llama-3.3-70b-versatile",
        temperature=temperature,
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": full_prompt},
        ],
    )
    return response.choices[0].message.content


# 7. สร้างอินเทอร์เฟซด้วย Streamlit
def main():
    st.set_page_config(
        page_title="RAG Chatbot  ",
        page_icon=":robot:",
        layout="wide",
    )
    st.title("AI Innovator LLM & RAG")

    st.subheader("ผู้พัฒนา AI Innovator LLM & RAG")
    st.write("พิชยะ สารเถื่อนแก้ว")


    st.subheader("Chatbot ที่ช่วยตอบคำถามเกี่ยวกับสถานที่ท่องเที่ยวในจังหวัดน่าน")

    # เพิ่มข้อมูลเอกสารลงใน Qdrant
    add_documents_to_qdrant(documents)
    st.success("ข้อมูลเอกสารพร้อมใช้งานแล้ว!")

    # รับคำถามจากผู้ใช้
    query = st.text_input("คุณ: ", placeholder="พิมพ์คำถามของคุณที่นี่...")

    if "messages" not in st.session_state:
        st.session_state["messages"] = [
            {
                "role": "assistant",
                "content": "สวัสดี มีอะไรให้ช่วยไหม :)",
            }
        ]

    if st.button("ส่ง"):
        if query:
            # สร้างคำตอบ
            answer = generate_answer(query)
            st.session_state["messages"].append({"role": "user", "content": query})
            st.session_state["messages"].append(
                {"role": "assistant", "content": answer}
            )
        else:
            st.warning("กรุณาพิมพ์คำถามก่อนส่ง")

    # แสดงผลลัพธ์
    for message in st.session_state["messages"]:
        if message["role"] == "assistant":
            st.write("Bot:", message["content"])
        elif message["role"] == "user":
            st.write("คุณ:", message["content"])


# เรียกใช้แอปพลิเคชัน
if __name__ == "__main__":
    main()
